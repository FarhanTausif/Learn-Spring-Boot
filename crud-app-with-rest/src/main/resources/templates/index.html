<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style.css}">
    <!-- Chart.js for dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Server-side data passed to JavaScript -->
    <script th:inline="javascript">
        // Thymeleaf variables passed to JavaScript
        window.serverData = {
            totalStudents: [[${totalStudents}]],
            totalCourses: [[${totalCourses}]],
            studentsWithCourses: [[${studentsWithCourses}]],
            studentsWithoutCourses: [[${studentsWithoutCourses}]],
            unassignedCourses: [[${unassignedCourses}]],
            enrollmentRate: [[${enrollmentRate}]],
            averageAge: [[${averageAge}]],
            recentStudents: [[${recentStudents}]],
            topCourses: [[${topCourses}]],
            contextPath: /*[[@{/}]]*/ '/'
        };

        // Configuration from Thymeleaf
        window.appConfig = {
            autoRefresh: true,
            refreshInterval: 30000, // 30 seconds
            animationDuration: 300,
            theme: 'light'
        };
    </script>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-graduation-cap"></i> Student Management System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a class="nav-link" href="/students"><i class="fas fa-users"></i> Students</a>
                    <a class="nav-link" href="/courses"><i class="fas fa-book"></i> Courses</a>
                    <a class="nav-link" href="/jpql-demo"><i class="fas fa-code"></i> JPQL Demo</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Dashboard Header with Real-time Clock -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="display-4"><i class="fas fa-chart-dashboard"></i> Dashboard</h1>
                <p class="lead">Real-time Student Management System</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <small class="text-muted">Last Updated:</small><br>
                        <span id="current-time" class="fw-bold"></span>
                        <button id="refreshBtn" class="btn btn-sm btn-outline-primary ms-2" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Statistics Cards with Animation -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary stat-card h-100 position-relative"
                     onclick="navigateToStudents()"
                     data-bs-toggle="tooltip"
                     title="Click to view all students">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title"><i class="fas fa-users"></i> Total Students</h6>
                                <h2 id="total-students-display" class="counter-animated"
                                    data-target="[[${totalStudents}]]"
                                    th:text="${totalStudents}">0</h2>
                                <small class="text-light">
                                    <span id="students-change" class="badge bg-light text-dark"></span>
                                </small>
                            </div>
                            <div class="align-self-center display-4">
                                <i class="fas fa-user-graduate opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar bg-light" id="students-progress" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success stat-card h-100"
                     onclick="navigateToCourses()"
                     data-bs-toggle="tooltip"
                     title="Click to view all courses">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title"><i class="fas fa-book"></i> Total Courses</h6>
                                <h2 id="total-courses-display" class="counter-animated"
                                    data-target="[[${totalCourses}]]"
                                    th:text="${totalCourses}">0</h2>
                                <small class="text-light">
                                    <span id="courses-change" class="badge bg-light text-dark"></span>
                                </small>
                            </div>
                            <div class="align-self-center display-4">
                                <i class="fas fa-book-open opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar bg-light" id="courses-progress" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card text-white bg-info stat-card h-100"
                     onclick="showEnrollmentDetails()"
                     data-bs-toggle="tooltip"
                     title="Students enrolled in courses">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title"><i class="fas fa-graduation-cap"></i> Enrolled</h6>
                                <h2 id="enrolled-students-display" class="counter-animated"
                                    data-target="[[${studentsWithCourses}]]"
                                    th:text="${studentsWithCourses}">0</h2>
                                <small class="text-light">
                                    Enrollment Rate: <span id="enrollment-rate" th:text="${enrollmentRate} + '%'">0%</span>
                                </small>
                            </div>
                            <div class="align-self-center display-4">
                                <i class="fas fa-chart-line opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar bg-light" id="enrollment-progress"
                             th:style="'width: ' + ${enrollmentRate} + '%'"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning stat-card h-100"
                     onclick="showUnassignedCourses()"
                     data-bs-toggle="tooltip"
                     title="Available courses for assignment">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title"><i class="fas fa-inbox"></i> Available</h6>
                                <h2 id="unassigned-courses-display" class="counter-animated"
                                    data-target="[[${unassignedCourses}]]"
                                    th:text="${unassignedCourses}">0</h2>
                                <small class="text-warning-emphasis">Ready for assignment</small>
                            </div>
                            <div class="align-self-center display-4">
                                <i class="fas fa-plus-circle opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Content Row -->
        <div class="row mb-4">
            <!-- Main Content Area -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area"></i>
                            <span id="content-title">System Analytics</span>
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active"
                                    onclick="showAnalytics()" id="analytics-tab">Analytics</button>
                            <button type="button" class="btn btn-outline-primary"
                                    onclick="showRecentActivity()" id="activity-tab">Activity</button>
                            <button type="button" class="btn btn-outline-primary"
                                    onclick="showQuickStats()" id="stats-tab">Stats</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="loading-spinner" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading data...</p>
                        </div>

                        <!-- Dynamic Content Container -->
                        <div id="dynamic-content">
                            <!-- Analytics Chart -->
                            <div id="analytics-content" class="content-section">
                                <canvas id="enrollmentChart" width="400" height="200"></canvas>
                            </div>

                            <!-- Recent Activity -->
                            <div id="activity-content" class="content-section d-none">
                                <div id="recent-students-list">
                                    <h6><i class="fas fa-user-clock"></i> Recent Students</h6>
                                    <div class="list-group" th:if="${recentStudents}">
                                        <div class="list-group-item d-flex justify-content-between align-items-center"
                                             th:each="student : ${recentStudents}"
                                             th:onclick="'viewStudentDetails(' + ${student.studentId} + ')'">
                                            <div>
                                                <strong th:text="${student.name}">Student Name</strong><br>
                                                <small class="text-muted" th:text="${student.email}">email@example.com</small>
                                            </div>
                                            <span class="badge bg-primary rounded-pill"
                                                  th:text="${student.age} + ' years'">Age</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div id="stats-content" class="content-section d-none">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <h3 id="avg-age-display" th:text="${averageAge}">0</h3>
                                        <p class="text-muted">Average Age</p>
                                    </div>
                                    <div class="col-md-4">
                                        <h3 id="completion-rate">85%</h3>
                                        <p class="text-muted">Course Completion</p>
                                    </div>
                                    <div class="col-md-4">
                                        <h3 id="active-users">[[${totalStudents + totalCourses}]]</h3>
                                        <p class="text-muted">Total Records</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Quick Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-tools"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="quickAddStudent()">
                                <i class="fas fa-user-plus"></i> Add Student
                            </button>
                            <button class="btn btn-success" onclick="quickAddCourse()">
                                <i class="fas fa-book-plus"></i> Add Course
                            </button>
                            <button class="btn btn-info" onclick="assignCourse()">
                                <i class="fas fa-link"></i> Assign Course
                            </button>
                            <button class="btn btn-warning" onclick="generateReport()">
                                <i class="fas fa-chart-bar"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Database</span>
                            <span class="badge bg-success" id="db-status">Online</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>API Response</span>
                            <span class="badge bg-success" id="api-status">< 100ms</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Last Sync</span>
                            <span class="text-muted" id="last-sync">Just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript with Thymeleaf Integration -->
    <script th:inline="javascript">
        // Dashboard Management Class
        class Dashboard {
            constructor() {
                this.data = window.serverData;
                this.config = window.appConfig;
                this.chart = null;
                this.refreshTimer = null;

                this.init();
            }

            init() {
                this.setupRealTimeClock();
                this.setupCounterAnimations();
                this.initializeChart();
                this.setupAutoRefresh();
                this.setupTooltips();
                this.checkSystemStatus();

                console.log('Dashboard initialized with server data:', this.data);
            }

            setupRealTimeClock() {
                const updateTime = () => {
                    const now = new Date();
                    document.getElementById('current-time').textContent =
                        now.toLocaleTimeString();
                };

                updateTime();
                setInterval(updateTime, 1000);
            }

            setupCounterAnimations() {
                const counters = document.querySelectorAll('.counter-animated');

                counters.forEach(counter => {
                    const target = parseInt(counter.getAttribute('data-target'));
                    const duration = 2000; // 2 seconds
                    const step = target / (duration / 16); // 60fps
                    let current = 0;

                    const timer = setInterval(() => {
                        current += step;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        counter.textContent = Math.floor(current);
                    }, 16);
                });
            }

            initializeChart() {
                const ctx = document.getElementById('enrollmentChart').getContext('2d');

                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Enrolled Students', 'Students without Courses', 'Available Courses'],
                        datasets: [{
                            data: [
                                this.data.studentsWithCourses,
                                this.data.studentsWithoutCourses,
                                this.data.unassignedCourses
                            ],
                            backgroundColor: [
                                '#198754', // success
                                '#ffc107', // warning
                                '#0d6efd'  // primary
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            setupAutoRefresh() {
                if (this.config.autoRefresh) {
                    this.refreshTimer = setInterval(() => {
                        this.refreshData();
                    }, this.config.refreshInterval);
                }
            }

            setupTooltips() {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            }

            async refreshData() {
                try {
                    const response = await fetch('/api/dashboard/stats');
                    const newData = await response.json();

                    this.updateCounters(newData);
                    this.updateChart(newData);
                    this.showDataChangeIndicators(newData);

                    document.getElementById('last-sync').textContent = 'Just now';
                } catch (error) {
                    console.error('Failed to refresh data:', error);
                    document.getElementById('api-status').textContent = 'Error';
                    document.getElementById('api-status').className = 'badge bg-danger';
                }
            }

            updateCounters(newData) {
                const updates = {
                    'total-students-display': newData.totalStudents,
                    'total-courses-display': newData.totalCourses,
                    'enrolled-students-display': newData.studentsWithCourses,
                    'unassigned-courses-display': newData.unassignedCourses
                };

                Object.entries(updates).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        this.animateCounterChange(element, parseInt(element.textContent), value);
                    }
                });
            }

            animateCounterChange(element, from, to) {
                const duration = 500;
                const step = (to - from) / (duration / 16);
                let current = from;

                const timer = setInterval(() => {
                    current += step;
                    if ((step > 0 && current >= to) || (step < 0 && current <= to)) {
                        current = to;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 16);
            }

            showDataChangeIndicators(newData) {
                const changes = {
                    'students-change': newData.totalStudents - this.data.totalStudents,
                    'courses-change': newData.totalCourses - this.data.totalCourses
                };

                Object.entries(changes).forEach(([id, change]) => {
                    const element = document.getElementById(id);
                    if (element && change !== 0) {
                        element.textContent = change > 0 ? `+${change}` : change;
                        element.className = `badge ${change > 0 ? 'bg-success' : 'bg-danger'} text-white`;
                        setTimeout(() => element.textContent = '', 3000);
                    }
                });

                this.data = newData; // Update stored data
            }

            checkSystemStatus() {
                // Simulate system health checks
                setInterval(() => {
                    const dbStatus = document.getElementById('db-status');
                    const apiStatus = document.getElementById('api-status');

                    // Simulate random response times
                    const responseTime = Math.floor(Math.random() * 150) + 50;
                    apiStatus.textContent = `< ${responseTime}ms`;
                    apiStatus.className = responseTime < 100 ? 'badge bg-success' : 'badge bg-warning';
                }, 5000);
            }
        }

        // Initialize dashboard when DOM is loaded
        let dashboard;
        document.addEventListener('DOMContentLoaded', function() {
            dashboard = new Dashboard();
        });

        // Tab switching functions
        function showAnalytics() {
            switchTab('analytics', 'Analytics');
        }

        function showRecentActivity() {
            switchTab('activity', 'Recent Activity');
        }

        function showQuickStats() {
            switchTab('stats', 'Quick Statistics');
        }

        function switchTab(tabName, title) {
            // Update tab buttons
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Update content title
            document.getElementById('content-title').textContent = title;

            // Show/hide content sections
            document.querySelectorAll('.content-section').forEach(section => section.classList.add('d-none'));
            document.getElementById(`${tabName}-content`).classList.remove('d-none');
        }

        // Navigation functions with Thymeleaf integration
        function navigateToStudents() {
            window.location.href = /*[[@{/students}]]*/ '/students';
        }

        function navigateToCourses() {
            window.location.href = /*[[@{/courses}]]*/ '/courses';
        }

        function viewStudentDetails(studentId) {
            window.location.href = /*[[@{/student/}]]*/ '/student/' + studentId;
        }

        // Quick action functions
        async function quickAddStudent() {
            const name = prompt('Enter student name:');
            const email = prompt('Enter student email:');
            const age = prompt('Enter student age:');

            if (name && email && age) {
                try {
                    const response = await fetch('/api/students', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, age: parseInt(age) })
                    });

                    if (response.ok) {
                        dashboard.refreshData();
                        alert('Student added successfully!');
                    } else {
                        alert('Failed to add student');
                    }
                } catch (error) {
                    alert('Error adding student: ' + error.message);
                }
            }
        }

        async function quickAddCourse() {
            const title = prompt('Enter course title:');
            const credits = prompt('Enter course credits:');

            if (title && credits) {
                try {
                    const response = await fetch('/api/courses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, credits: parseInt(credits) })
                    });

                    if (response.ok) {
                        dashboard.refreshData();
                        alert('Course added successfully!');
                    } else {
                        alert('Failed to add course');
                    }
                } catch (error) {
                    alert('Error adding course: ' + error.message);
                }
            }
        }

        function refreshDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn.querySelector('i');

            icon.classList.add('fa-spin');
            dashboard.refreshData().finally(() => {
                setTimeout(() => icon.classList.remove('fa-spin'), 500);
            });
        }

        function assignCourse() {
            window.location.href = /*[[@{/courses}]]*/ '/courses?action=assign';
        }

        function generateReport() {
            window.location.href = /*[[@{/reports}]]*/ '/reports';
        }

        function showEnrollmentDetails() {
            switchTab('analytics', 'Enrollment Analytics');
        }

        function showUnassignedCourses() {
            window.location.href = /*[[@{/courses}]]*/ '/courses?filter=unassigned';
        }
    </script>
</body>
</html>
