<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - Student Management System'">Students Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style.css}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-graduation-cap"></i> Student Management System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a class="nav-link active" href="/students"><i class="fas fa-users"></i> Students</a>
                    <a class="nav-link" href="/courses"><i class="fas fa-book"></i> Courses</a>
                    <a class="nav-link" href="/jpql-demo"><i class="fas fa-code"></i> JPQL Demo</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="display-5"><i class="fas fa-users text-primary"></i> Students Management</h1>
                <p class="lead">Manage student records with real-time updates and advanced filtering</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    <i class="fas fa-user-plus"></i> Add New Student
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshStudents()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Statistics Cards (populated from WebController) -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h6><i class="fas fa-users"></i> Total Students</h6>
                        <h3 id="total-students-count" th:text="${totalStudents}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h6><i class="fas fa-graduation-cap"></i> With Courses</h6>
                        <h3 id="students-with-courses-count" th:text="${studentsWithCourses}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h6><i class="fas fa-clock"></i> Average Age</h6>
                        <h3 id="average-age">
                            <span th:if="${ageDistribution != null and !ageDistribution.isEmpty()}"
                                  th:text="${#numbers.formatDecimal(ageDistribution.values().stream().mapToInt(v -> v).average().orElse(0), 1, 1)}">0</span>
                            <span th:unless="${ageDistribution != null and !ageDistribution.isEmpty()}">0</span>
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h6><i class="fas fa-user-times"></i> Without Courses</h6>
                        <h3 id="students-without-courses-count" th:text="${studentsWithoutCourses}">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filters & Search</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Search by Name or Email</label>
                                <div class="input-group">
                                    <input type="text" id="searchInput" class="form-control" placeholder="Type to search...">
                                    <button class="btn btn-outline-secondary" onclick="searchStudents()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Age Filter</label>
                                <select id="ageFilter" class="form-select" onchange="filterStudents()">
                                    <option value="">All Ages</option>
                                    <option th:each="ageGroup : ${ageDistribution.keySet()}"
                                            th:value="${ageGroup}" th:text="${ageGroup}">Age Group</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Course Status</label>
                                <select id="courseStatusFilter" class="form-select" onchange="filterStudents()">
                                    <option value="">All Students</option>
                                    <option value="with-courses">With Courses</option>
                                    <option value="without-courses">Without Courses</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">View Mode</label>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" onclick="setViewMode('cards')" id="cardsViewBtn">
                                        <i class="fas fa-th"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="setViewMode('table')" id="tableViewBtn">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Display Area -->
        <div id="students-container">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading students...</span>
                </div>
                <p class="mt-2">Loading students...</p>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="studentName" required>
                            <div class="invalid-feedback">Please provide a valid name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="studentEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="studentEmail" required>
                            <div class="invalid-feedback">Please provide a valid email.</div>
                        </div>
                        <div class="mb-3">
                            <label for="studentAge" class="form-label">Age *</label>
                            <input type="number" class="form-control" id="studentAge" min="16" max="100" required>
                            <div class="invalid-feedback">Age must be between 16 and 100.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addStudent()">
                        <i class="fas fa-save"></i> Add Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="mb-3">
                            <label for="editStudentName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="editStudentEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentAge" class="form-label">Age *</label>
                            <input type="number" class="form-control" id="editStudentAge" min="16" max="100" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateStudent()">
                        <i class="fas fa-save"></i> Update Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle"></i> <span id="successMessage">Success!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle"></i> <span id="errorMessage">Error occurred!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        let students = [];
        let filteredStudents = [];
        let currentViewMode = 'cards';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();

            // Setup real-time search
            document.getElementById('searchInput').addEventListener('input', debounce(searchStudents, 300));
        });

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Show toast notifications
        function showToast(type, message) {
            document.getElementById(type + 'Message').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById(type + 'Toast'));
            toast.show();
        }

        // Load all students
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                students = await response.json();
                filteredStudents = [...students];

                updateStatistics();
                displayStudents();
            } catch (error) {
                console.error('Error loading students:', error);
                showToast('error', 'Failed to load students');
            }
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('total-students-count').textContent = students.length;

            // Load students with courses count
            fetch('/api/students/count-with-courses')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('students-with-courses-count').textContent = data.studentsWithCoursesCount;
                    document.getElementById('students-without-courses-count').textContent =
                        students.length - data.studentsWithCoursesCount;
                });

            // Calculate average age
            const avgAge = students.length > 0 ?
                (students.reduce((sum, s) => sum + s.age, 0) / students.length).toFixed(1) : 0;
            document.getElementById('average-age').textContent = avgAge;
        }

        // Display students based on current view mode
        function displayStudents() {
            const container = document.getElementById('students-container');

            if (filteredStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-user-slash fa-3x mb-3"></i>
                        <h4>No Students Found</h4>
                        <p>Try adjusting your search criteria or add a new student.</p>
                    </div>`;
                return;
            }

            if (currentViewMode === 'cards') {
                displayStudentsAsCards();
            } else {
                displayStudentsAsTable();
            }
        }

        // Display students as cards
        function displayStudentsAsCards() {
            const container = document.getElementById('students-container');
            let html = '<div class="row">';

            filteredStudents.forEach(student => {
                html += `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card student-card h-100">
                        <div class="card-body position-relative">
                            <span class="badge bg-secondary age-badge position-absolute top-0 end-0 m-2">${student.age} years</span>
                            <h5 class="card-title">
                                <i class="fas fa-user text-primary"></i> ${student.name}
                            </h5>
                            <p class="card-text">
                                <i class="fas fa-envelope text-muted"></i> ${student.email}<br>
                                <small class="text-muted">Student ID: ${student.studentId}</small>
                            </p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info" onclick="viewStudentDetails(${student.studentId})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editStudentModal(${student.studentId})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteStudent(${student.studentId}, '${student.name}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Display students as table
        function displayStudentsAsTable() {
            const container = document.getElementById('students-container');
            let html = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Age</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

            filteredStudents.forEach(student => {
                html += `
                <tr>
                    <td>${student.studentId}</td>
                    <td><i class="fas fa-user text-primary"></i> ${student.name}</td>
                    <td><i class="fas fa-envelope text-muted"></i> ${student.email}</td>
                    <td><span class="badge bg-secondary">${student.age} years</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-info" onclick="viewStudentDetails(${student.studentId})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editStudentModal(${student.studentId})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteStudent(${student.studentId}, '${student.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });

            html += `
                    </tbody>
                </table>
            </div>`;
            container.innerHTML = html;
        }

        // Set view mode
        function setViewMode(mode) {
            currentViewMode = mode;

            // Update button states
            document.getElementById('cardsViewBtn').classList.toggle('active', mode === 'cards');
            document.getElementById('tableViewBtn').classList.toggle('active', mode === 'table');

            displayStudents();
        }

        // Search students
        function searchStudents() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            if (!query) {
                filteredStudents = [...students];
            } else {
                filteredStudents = students.filter(student =>
                    student.name.toLowerCase().includes(query) ||
                    student.email.toLowerCase().includes(query)
                );
            }

            displayStudents();
        }

        // Filter students
        function filterStudents() {
            const ageFilter = document.getElementById('ageFilter').value;
            const courseStatusFilter = document.getElementById('courseStatusFilter').value;

            filteredStudents = students.filter(student => {
                // Age filter
                if (ageFilter) {
                    const age = student.age;
                    switch(ageFilter) {
                        case '16-20': if (age < 16 || age > 20) return false; break;
                        case '21-25': if (age < 21 || age > 25) return false; break;
                        case '26-30': if (age < 26 || age > 30) return false; break;
                        case '31+': if (age < 31) return false; break;
                    }
                }

                return true;
            });

            // Apply course status filter if needed
            if (courseStatusFilter === 'with-courses' || courseStatusFilter === 'without-courses') {
                fetch(`/api/students/${courseStatusFilter}`)
                    .then(r => r.json())
                    .then(data => {
                        const studentIds = data.map(s => s.studentId);
                        filteredStudents = filteredStudents.filter(s => studentIds.includes(s.studentId));
                        displayStudents();
                    });
            } else {
                displayStudents();
            }
        }

        // Add new student
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const age = parseInt(document.getElementById('studentAge').value);

            if (!name || !email || !age) {
                showToast('error', 'Please fill all required fields');
                return;
            }

            const studentData = { name, email, age };

            try {
                const response = await fetch('/api/students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });

                if (response.ok) {
                    const newStudent = await response.json();
                    students.push(newStudent);
                    filteredStudents = [...students];
                    updateStatistics();
                    displayStudents();

                    // Close modal and reset form
                    bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                    document.getElementById('addStudentForm').reset();

                    showToast('success', 'Student added successfully!');
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to add student');
                }
            } catch (error) {
                console.error('Error adding student:', error);
                showToast('error', 'Failed to add student');
            }
        }

        // Edit student modal
        function editStudentModal(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (!student) return;

            document.getElementById('editStudentId').value = student.studentId;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentEmail').value = student.email;
            document.getElementById('editStudentAge').value = student.age;

            new bootstrap.Modal(document.getElementById('editStudentModal')).show();
        }

        // Update student
        async function updateStudent() {
            const id = document.getElementById('editStudentId').value;
            const name = document.getElementById('editStudentName').value.trim();
            const email = document.getElementById('editStudentEmail').value.trim();
            const age = parseInt(document.getElementById('editStudentAge').value);

            const studentData = { name, email, age };

            try {
                const response = await fetch(`/api/students/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });

                if (response.ok) {
                    const updatedStudent = await response.json();
                    const index = students.findIndex(s => s.studentId == id);
                    students[index] = updatedStudent;
                    filteredStudents = [...students];
                    updateStatistics();
                    displayStudents();

                    bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                    showToast('success', 'Student updated successfully!');
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to update student');
                }
            } catch (error) {
                console.error('Error updating student:', error);
                showToast('error', 'Failed to update student');
            }
        }

        // View student details
        function viewStudentDetails(studentId) {
            window.location.href = `/student/${studentId}`;
        }

        // Confirm delete student
        function confirmDeleteStudent(studentId, studentName) {
            if (confirm(`Are you sure you want to delete ${studentName}? This will also delete all associated courses.`)) {
                deleteStudent(studentId);
            }
        }

        // Delete student
        async function deleteStudent(studentId) {
            try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    students = students.filter(s => s.studentId !== studentId);
                    filteredStudents = [...students];
                    updateStatistics();
                    displayStudents();
                    showToast('success', 'Student deleted successfully');
                } else {
                    showToast('error', 'Failed to delete student');
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                showToast('error', 'Failed to delete student');
            }
        }

        // Refresh students
        function refreshStudents() {
            loadStudents();
            showToast('success', 'Students refreshed successfully');
        }
    </script>
</body>
</html>
