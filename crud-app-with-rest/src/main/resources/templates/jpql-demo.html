<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - Student Management System'">JPQL Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style.css}">
    <!-- Monaco Editor for SQL syntax highlighting -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/editor/editor.main.css">
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        .query-section {
            border-left: 4px solid #007bff;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s ease;
        }
        .query-section:hover {
            border-left-color: #28a745;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .query-editor {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-height: 200px;
        }
        .results-panel {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .execution-time {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .query-example {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .query-example:hover {
            background-color: rgba(0,123,255,0.1);
        }
        .performance-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .method-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- Server Data for JavaScript -->
    <script th:inline="javascript">
        // JPQL Demo Configuration from server
        window.jpqlDemoData = {
            totalDerivedMethods: [[${totalDerivedMethods ?: 25}]],
            queryTypes: [[${queryTypes}]],
            performanceMetrics: [[${performanceMetrics}]],
            contextPath: /*[[@{/}]]*/ '/',

            // API endpoints for JPQL testing
            endpoints: {
                testQuery: /*[[@{/api/jpql/test}]]*/ '/api/jpql/test',
                derivedMethods: /*[[@{/api/jpql/derived-methods}]]*/ '/api/jpql/derived-methods',
                queryExamples: /*[[@{/api/jpql/examples}]]*/ '/api/jpql/examples',
                explainQuery: /*[[@{/api/jpql/explain}]]*/ '/api/jpql/explain'
            },

            // Predefined queries with categories
            exampleQueries: {
                basic: [
                    {
                        title: "Find All Students",
                        query: "SELECT s FROM Student s",
                        description: "Basic entity selection"
                    },
                    {
                        title: "Find Student by Name",
                        query: "SELECT s FROM Student s WHERE s.name = :name",
                        description: "Parameter-based filtering",
                        params: { name: "John Doe" }
                    }
                ],
                advanced: [
                    {
                        title: "Students with Courses Count",
                        query: "SELECT s.name, COUNT(c) FROM Student s LEFT JOIN Course c ON c.studentId = s.studentId GROUP BY s.studentId, s.name",
                        description: "Join with aggregation"
                    },
                    {
                        title: "Average Age by Course Count",
                        query: "SELECT COUNT(c), AVG(s.age) FROM Student s LEFT JOIN Course c ON c.studentId = s.studentId GROUP BY s.studentId HAVING COUNT(c) > 0",
                        description: "Complex aggregation with HAVING"
                    }
                ],
                derived: [
                    {
                        title: "findByNameContaining",
                        method: "List<Student> findByNameContaining(String name)",
                        query: "SELECT s FROM Student s WHERE s.name LIKE %:name%",
                        description: "Spring Data JPA derived method"
                    },
                    {
                        title: "findByAgeGreaterThanAndNameStartingWith",
                        method: "List<Student> findByAgeGreaterThanAndNameStartingWith(int age, String name)",
                        query: "SELECT s FROM Student s WHERE s.age > :age AND s.name LIKE :name%",
                        description: "Multiple condition derived method"
                    }
                ]
            },

            // Configuration
            config: {
                maxQueryLength: 1000,
                executionTimeout: 30000,
                autoSave: true,
                syntaxHighlighting: true
            }
        };

        // User interaction tracking for analytics
        window.userActivity = {
            queriesExecuted: 0,
            totalExecutionTime: 0,
            favoriteQueryTypes: [],
            sessionStartTime: Date.now()
        };
    </script>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-graduation-cap"></i> Student Management System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a class="nav-link" href="/students"><i class="fas fa-users"></i> Students</a>
                    <a class="nav-link" href="/courses"><i class="fas fa-book"></i> Courses</a>
                    <a class="nav-link active" href="/jpql-demo"><i class="fas fa-code"></i> JPQL Demo</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="display-5">
                    <i class="fas fa-code text-primary"></i>
                    JPQL Interactive Demo
                </h1>
                <p class="lead">Learn and test JPQL queries with real-time execution and feedback</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button class="btn btn-success" onclick="executeQuery()" id="executeBtn">
                        <i class="fas fa-play"></i> Execute Query
                    </button>
                    <button class="btn btn-outline-primary" onclick="clearEditor()">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                    <button class="btn btn-outline-info" onclick="formatQuery()">
                        <i class="fas fa-align-left"></i> Format
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportResults('json')">JSON</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportResults('csv')">CSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportResults('sql')">SQL Script</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics and Performance Panel -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-info h-100">
                    <div class="card-body text-center">
                        <h3 id="session-queries-count">0</h3>
                        <p class="mb-0">Queries Executed</p>
                        <small>This Session</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success h-100">
                    <div class="card-body text-center">
                        <h3 id="avg-execution-time">0ms</h3>
                        <p class="mb-0">Avg Execution</p>
                        <small>Current Session</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning h-100">
                    <div class="card-body text-center">
                        <h3 th:text="${totalDerivedMethods ?: 25}">25</h3>
                        <p class="mb-0">Derived Methods</p>
                        <small>Available</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-primary h-100">
                    <div class="card-body text-center">
                        <h3 id="query-success-rate">100%</h3>
                        <p class="mb-0">Success Rate</p>
                        <small class="performance-badge">Excellent</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="row">
            <!-- Query Editor and Examples -->
            <div class="col-md-8">
                <!-- Query Editor -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-edit"></i> JPQL Query Editor
                        </h5>
                        <div class="d-flex gap-2">
                            <span class="badge bg-secondary" id="query-length">0/1000</span>
                            <span class="badge bg-info" id="cursor-position">Line 1, Col 1</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="query-editor" id="query-editor">
                            <textarea class="form-control" id="jpqlQueryInput"
                                      rows="8"
                                      placeholder="Enter your JPQL query here...&#10;&#10;Example:&#10;SELECT s FROM Student s WHERE s.age > :minAge"
                                      oninput="updateQueryInfo()"
                                      onkeydown="handleEditorKeydown(event)"></textarea>
                        </div>

                        <!-- Query Parameters -->
                        <div class="mt-3" id="parametersSection" style="display: none;">
                            <h6><i class="fas fa-cogs"></i> Query Parameters</h6>
                            <div id="parameterInputs" class="row"></div>
                        </div>

                        <!-- Query Validation -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div id="queryValidation" class="text-muted">
                                    <i class="fas fa-check-circle text-success"></i> Query syntax looks good
                                </div>
                                <button class="btn btn-sm btn-outline-info" onclick="explainQuery()">
                                    <i class="fas fa-question-circle"></i> Explain Query
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table"></i> Query Results
                        </h5>
                        <div class="d-flex gap-2">
                            <span class="badge bg-success execution-time" id="lastExecutionTime" style="display: none;">
                                <i class="fas fa-clock"></i> 0ms
                            </span>
                            <span class="badge bg-info" id="resultCount" style="display: none;">
                                0 results
                            </span>
                        </div>
                    </div>
                    <div class="card-body results-panel">
                        <div id="queryResults">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-play-circle fa-3x mb-3"></i>
                                <h5>Ready to Execute</h5>
                                <p>Enter a JPQL query above and click "Execute Query" to see results</p>
                            </div>
                        </div>

                        <!-- Execution History -->
                        <div id="executionHistory" class="mt-4" style="display: none;">
                            <h6><i class="fas fa-history"></i> Execution History</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Query</th>
                                            <th>Duration</th>
                                            <th>Results</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar with Examples and Methods -->
            <div class="col-md-4">
                <!-- Query Categories -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-folder-open"></i> Query Examples
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-3" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab"
                                        data-bs-target="#basic-queries" role="tab">Basic</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab"
                                        data-bs-target="#advanced-queries" role="tab">Advanced</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab"
                                        data-bs-target="#derived-methods" role="tab">Derived</button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- Basic Queries -->
                            <div class="tab-pane fade show active" id="basic-queries">
                                <div class="query-examples-container" data-category="basic"></div>
                            </div>

                            <!-- Advanced Queries -->
                            <div class="tab-pane fade" id="advanced-queries">
                                <div class="query-examples-container" data-category="advanced"></div>
                            </div>

                            <!-- Derived Methods -->
                            <div class="tab-pane fade" id="derived-methods">
                                <div class="query-examples-container" data-category="derived"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JPQL Reference -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-book"></i> JPQL Quick Reference
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="jpqlAccordion">
                            <!-- SELECT Statements -->
                            <div class="accordion-item">
                                <h6 class="accordion-header">
                                    <button class="accordion-button collapsed" data-bs-toggle="collapse"
                                            data-bs-target="#selectReference">
                                        SELECT Statements
                                    </button>
                                </h6>
                                <div id="selectReference" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="code-block">
                                            SELECT entity FROM Entity entity<br>
                                            SELECT e.property FROM Entity e<br>
                                            SELECT NEW dto(...) FROM Entity e
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- WHERE Clauses -->
                            <div class="accordion-item">
                                <h6 class="accordion-header">
                                    <button class="accordion-button collapsed" data-bs-toggle="collapse"
                                            data-bs-target="#whereReference">
                                        WHERE Clauses
                                    </button>
                                </h6>
                                <div id="whereReference" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="code-block">
                                            WHERE e.property = :param<br>
                                            WHERE e.property LIKE '%value%'<br>
                                            WHERE e.property IN (:list)<br>
                                            WHERE e.property BETWEEN :min AND :max
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- JOIN Operations -->
                            <div class="accordion-item">
                                <h6 class="accordion-header">
                                    <button class="accordion-button collapsed" data-bs-toggle="collapse"
                                            data-bs-target="#joinReference">
                                        JOIN Operations
                                    </button>
                                </h6>
                                <div id="joinReference" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div class="code-block">
                                            LEFT JOIN entity.association a<br>
                                            INNER JOIN entity.association a<br>
                                            JOIN FETCH entity.association
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tips -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb"></i> Performance Tips
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item border-0 px-0">
                                <strong>Use Indexes:</strong> Ensure WHERE clauses use indexed columns
                            </div>
                            <div class="list-group-item border-0 px-0">
                                <strong>Avoid N+1:</strong> Use JOIN FETCH for associations
                            </div>
                            <div class="list-group-item border-0 px-0">
                                <strong>Pagination:</strong> Use setFirstResult() and setMaxResults()
                            </div>
                            <div class="list-group-item border-0 px-0">
                                <strong>Projections:</strong> Select only needed fields with NEW
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Explanation Modal -->
    <div class="modal fade" id="queryExplanationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle"></i> Query Explanation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="queryExplanationContent">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successMessage">Success!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage">Error occurred!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- JPQL Demo JavaScript with Advanced Thymeleaf Integration -->
    <script th:inline="javascript">
        // JPQL Demo Manager Class
        class JPQLDemoManager {
            constructor() {
                this.currentQuery = '';
                this.queryHistory = [];
                this.parameters = new Map();
                this.executionStats = {
                    queriesExecuted: 0,
                    totalTime: 0,
                    successfulQueries: 0
                };

                this.init();
            }

            init() {
                this.loadQueryExamples();
                this.setupEventListeners();
                this.loadUserPreferences();
                this.initializeEditor();

                console.log('JPQL Demo Manager initialized with config:', window.jpqlDemoData);
            }

            setupEventListeners() {
                // Auto-save functionality
                const queryInput = document.getElementById('jpqlQueryInput');
                queryInput.addEventListener('input', () => {
                    if (window.jpqlDemoData.config.autoSave) {
                        this.saveQueryToLocalStorage();
                    }
                    this.validateQuery();
                    this.extractParameters();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'Enter': // Ctrl+Enter to execute
                                e.preventDefault();
                                this.executeQuery();
                                break;
                            case 's': // Ctrl+S to save
                                e.preventDefault();
                                this.saveQuery();
                                break;
                            case 'k': // Ctrl+K to clear
                                e.preventDefault();
                                this.clearEditor();
                                break;
                        }
                    }
                });

                // Tab switching to load examples
                document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                    tab.addEventListener('shown.bs.tab', (e) => {
                        const targetId = e.target.getAttribute('data-bs-target');
                        const category = targetId.replace('#', '').replace('-queries', '').replace('-methods', '');
                        this.loadCategoryExamples(category);
                    });
                });
            }

            initializeEditor() {
                // Load saved query if exists
                const savedQuery = localStorage.getItem('jpql-demo-query');
                if (savedQuery) {
                    document.getElementById('jpqlQueryInput').value = savedQuery;
                    this.updateQueryInfo();
                    this.validateQuery();
                    this.extractParameters();
                }
            }

            loadQueryExamples() {
                // Load basic examples first (active tab)
                this.loadCategoryExamples('basic');
            }

            loadCategoryExamples(category) {
                const container = document.querySelector(`[data-category="${category}"]`);
                if (!container) return;

                const examples = window.jpqlDemoData.exampleQueries[category] || [];

                container.innerHTML = examples.map(example => {
                    if (category === 'derived') {
                        return this.createDerivedMethodCard(example);
                    } else {
                        return this.createQueryExampleCard(example);
                    }
                }).join('');
            }

            createQueryExampleCard(example) {
                return `
                    <div class="card query-section mb-3" onclick="jpqlDemo.loadExample('${this.escapeForJS(example.query)}', '${this.escapeForJS(example.title)}')">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-code text-primary"></i> ${example.title}
                            </h6>
                            <p class="card-text text-muted small mb-2">${example.description}</p>
                            <div class="code-block small">
                                ${this.highlightJPQL(example.query)}
                            </div>
                            ${example.params ? `
                                <div class="mt-2">
                                    <small class="text-info">
                                        <i class="fas fa-cogs"></i> Parameters: ${Object.keys(example.params).join(', ')}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            createDerivedMethodCard(example) {
                return `
                    <div class="card method-card mb-3" onclick="jpqlDemo.loadDerivedMethod('${this.escapeForJS(example.query)}', '${this.escapeForJS(example.method)}')">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-magic text-warning"></i> ${example.title}
                            </h6>
                            <p class="card-text small mb-2">${example.description}</p>
                            <div class="mb-2">
                                <strong class="text-light">Method:</strong><br>
                                <code class="text-warning">${example.method}</code>
                            </div>
                            <div>
                                <strong class="text-light">Generated JPQL:</strong><br>
                                <code class="text-info small">${example.query}</code>
                            </div>
                        </div>
                    </div>
                `;
            }

            highlightJPQL(query) {
                // Simple JPQL syntax highlighting
                return query
                    .replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|GROUP BY|ORDER BY|HAVING|AND|OR|NOT|IN|LIKE|BETWEEN)\b/gi,
                             '<span class="text-warning fw-bold">$1</span>')
                    .replace(/:\w+/g, '<span class="text-success">$&</span>')
                    .replace(/'[^']*'/g, '<span class="text-info">$&</span>');
            }

            escapeForJS(str) {
                if (!str) return '';
                return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
            }

            loadExample(query, title) {
                document.getElementById('jpqlQueryInput').value = query;
                this.currentQuery = query;
                this.updateQueryInfo();
                this.validateQuery();
                this.extractParameters();
                this.showToast('success', `Loaded example: ${title}`);

                // Track usage
                window.userActivity.favoriteQueryTypes.push('example');
            }

            loadDerivedMethod(query, method) {
                document.getElementById('jpqlQueryInput').value = query;
                this.currentQuery = query;
                this.updateQueryInfo();
                this.validateQuery();
                this.extractParameters();
                this.showToast('success', `Loaded derived method: ${method.split('(')[0]}`);

                // Track usage
                window.userActivity.favoriteQueryTypes.push('derived');
            }

            updateQueryInfo() {
                const queryInput = document.getElementById('jpqlQueryInput');
                const query = queryInput.value;

                // Update character count
                document.getElementById('query-length').textContent =
                    `${query.length}/${window.jpqlDemoData.config.maxQueryLength}`;

                // Update cursor position
                const cursorPos = queryInput.selectionStart;
                const lines = query.substring(0, cursorPos).split('\n');
                const line = lines.length;
                const col = lines[lines.length - 1].length + 1;
                document.getElementById('cursor-position').textContent = `Line ${line}, Col ${col}`;

                this.currentQuery = query;
            }

            validateQuery() {
                const query = this.currentQuery.trim();
                const validation = document.getElementById('queryValidation');

                if (!query) {
                    validation.innerHTML = '<i class="fas fa-info-circle text-info"></i> Enter a JPQL query to validate';
                    return;
                }

                // Basic validation
                if (query.toLowerCase().includes('select') || query.toLowerCase().includes('update') || query.toLowerCase().includes('delete')) {
                    validation.innerHTML = '<i class="fas fa-check-circle text-success"></i> Query syntax looks good';
                } else {
                    validation.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Query should start with SELECT, UPDATE, or DELETE';
                }
            }

            extractParameters() {
                const parameterRegex = /:(\w+)/g;
                const matches = [...this.currentQuery.matchAll(parameterRegex)];
                const paramNames = [...new Set(matches.map(match => match[1]))];

                if (paramNames.length === 0) {
                    document.getElementById('parametersSection').style.display = 'none';
                    return;
                }

                document.getElementById('parametersSection').style.display = 'block';
                const container = document.getElementById('parameterInputs');

                container.innerHTML = paramNames.map(param => `
                    <div class="col-md-6 mb-2">
                        <label class="form-label small">${param}</label>
                        <input type="text" class="form-control form-control-sm"
                               id="param-${param}" placeholder="Enter value for ${param}">
                    </div>
                `).join('');
            }

            async executeQuery() {
                const query = this.currentQuery.trim();

                if (!query) {
                    this.showToast('error', 'Please enter a JPQL query');
                    return;
                }

                // Collect parameters
                const parameters = {};
                document.querySelectorAll('[id^="param-"]').forEach(input => {
                    const paramName = input.id.replace('param-', '');
                    const value = input.value.trim();
                    if (value) {
                        parameters[paramName] = value;
                    }
                });

                // Show loading state
                this.showExecutionLoading(true);
                const startTime = performance.now();

                try {
                    const response = await fetch(window.jpqlDemoData.endpoints.testQuery, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query, parameters })
                    });

                    const result = await response.json();
                    const executionTime = Math.round(performance.now() - startTime);

                    if (response.ok) {
                        this.displayQueryResults(result, executionTime);
                        this.updateExecutionStats(executionTime, true);
                        this.addToHistory(query, executionTime, result.length || 0);
                    } else {
                        this.displayError(result.error || 'Query execution failed');
                        this.updateExecutionStats(executionTime, false);
                    }

                } catch (error) {
                    const executionTime = Math.round(performance.now() - startTime);
                    this.displayError('Network error: ' + error.message);
                    this.updateExecutionStats(executionTime, false);
                } finally {
                    this.showExecutionLoading(false);
                }
            }

            displayQueryResults(results, executionTime) {
                const container = document.getElementById('queryResults');

                if (!Array.isArray(results) || results.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <h5>No Results</h5>
                            <p>The query executed successfully but returned no results.</p>
                        </div>
                    `;
                } else {
                    // Create responsive table
                    const headers = Object.keys(results[0]);
                    const tableHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        ${headers.map(header => `<th>${header}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(row => `
                                        <tr>
                                            ${headers.map(header => `<td>${this.formatCellValue(row[header])}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = tableHTML;
                }

                // Update result info
                document.getElementById('lastExecutionTime').textContent = `${executionTime}ms`;
                document.getElementById('lastExecutionTime').style.display = 'inline-block';
                document.getElementById('resultCount').textContent = `${results.length} result${results.length !== 1 ? 's' : ''}`;
                document.getElementById('resultCount').style.display = 'inline-block';

                this.showToast('success', `Query executed successfully in ${executionTime}ms`);
            }

            displayError(errorMessage) {
                const container = document.getElementById('queryResults');
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> Query Error</h5>
                        <p class="mb-0">${errorMessage}</p>
                    </div>
                `;

                this.showToast('error', 'Query execution failed');
            }

            formatCellValue(value) {
                if (value === null || value === undefined) {
                    return '<span class="text-muted">null</span>';
                }
                if (typeof value === 'object') {
                    return JSON.stringify(value);
                }
                return String(value);
            }

            updateExecutionStats(executionTime, success) {
                this.executionStats.queriesExecuted++;
                this.executionStats.totalTime += executionTime;

                if (success) {
                    this.executionStats.successfulQueries++;
                }

                // Update UI
                document.getElementById('session-queries-count').textContent = this.executionStats.queriesExecuted;

                const avgTime = Math.round(this.executionStats.totalTime / this.executionStats.queriesExecuted);
                document.getElementById('avg-execution-time').textContent = `${avgTime}ms`;

                const successRate = Math.round((this.executionStats.successfulQueries / this.executionStats.queriesExecuted) * 100);
                document.getElementById('query-success-rate').textContent = `${successRate}%`;

                // Update global user activity
                window.userActivity.queriesExecuted = this.executionStats.queriesExecuted;
                window.userActivity.totalExecutionTime = this.executionStats.totalTime;
            }

            addToHistory(query, executionTime, resultCount) {
                const historyEntry = {
                    timestamp: new Date(),
                    query: query.length > 50 ? query.substring(0, 50) + '...' : query,
                    fullQuery: query,
                    executionTime,
                    resultCount
                };

                this.queryHistory.unshift(historyEntry);

                // Keep only last 10 entries
                if (this.queryHistory.length > 10) {
                    this.queryHistory = this.queryHistory.slice(0, 10);
                }

                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const historySection = document.getElementById('executionHistory');
                const tbody = document.getElementById('historyTableBody');

                if (this.queryHistory.length === 0) {
                    historySection.style.display = 'none';
                    return;
                }

                historySection.style.display = 'block';

                tbody.innerHTML = this.queryHistory.map((entry, index) => `
                    <tr>
                        <td class="small">${entry.timestamp.toLocaleTimeString()}</td>
                        <td class="small" title="${entry.fullQuery}">${entry.query}</td>
                        <td class="small text-success">${entry.executionTime}ms</td>
                        <td class="small">${entry.resultCount}</td>
                        <td>
                            <button class="btn btn-xs btn-outline-primary"
                                    onclick="jpqlDemo.rerunQuery('${this.escapeForJS(entry.fullQuery)}')"
                                    title="Rerun query">
                                <i class="fas fa-redo"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            rerunQuery(query) {
                document.getElementById('jpqlQueryInput').value = query;
                this.updateQueryInfo();
                this.validateQuery();
                this.extractParameters();
                this.executeQuery();
            }

            showExecutionLoading(show) {
                const executeBtn = document.getElementById('executeBtn');

                if (show) {
                    executeBtn.disabled = true;
                    executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
                } else {
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '<i class="fas fa-play"></i> Execute Query';
                }
            }

            async explainQuery() {
                const query = this.currentQuery.trim();

                if (!query) {
                    this.showToast('error', 'Please enter a query to explain');
                    return;
                }

                try {
                    const response = await fetch(window.jpqlDemoData.endpoints.explainQuery, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    });

                    const explanation = await response.json();

                    if (response.ok) {
                        this.showQueryExplanation(explanation);
                    } else {
                        this.showToast('error', explanation.error || 'Failed to explain query');
                    }

                } catch (error) {
                    this.showToast('error', 'Failed to explain query: ' + error.message);
                }
            }

            showQueryExplanation(explanation) {
                const content = document.getElementById('queryExplanationContent');

                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Query Analysis</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong>Query Type:</strong>
                                    <span class="badge bg-primary">${explanation.type || 'SELECT'}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong>Entities:</strong>
                                    <span>${explanation.entities?.join(', ') || 'N/A'}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong>Parameters:</strong>
                                    <span>${explanation.parameters?.length || 0}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <strong>Complexity:</strong>
                                    <span class="badge bg-${explanation.complexity === 'LOW' ? 'success' : explanation.complexity === 'MEDIUM' ? 'warning' : 'danger'}">
                                        ${explanation.complexity || 'MEDIUM'}
                                    </span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance Tips</h6>
                            <div class="alert alert-info">
                                ${explanation.tips?.map(tip => `<li>${tip}</li>`).join('') || '<li>No specific tips for this query</li>'}
                            </div>
                        </div>
                    </div>

                    ${explanation.generatedSQL ? `
                        <div class="mt-3">
                            <h6>Generated SQL</h6>
                            <div class="code-block">
                                ${explanation.generatedSQL}
                            </div>
                        </div>
                    ` : ''}
                `;

                const modal = new bootstrap.Modal(document.getElementById('queryExplanationModal'));
                modal.show();
            }

            clearEditor() {
                document.getElementById('jpqlQueryInput').value = '';
                this.currentQuery = '';
                this.updateQueryInfo();
                document.getElementById('parametersSection').style.display = 'none';
                document.getElementById('queryValidation').innerHTML = '<i class="fas fa-info-circle text-info"></i> Enter a JPQL query to validate';

                // Clear results
                document.getElementById('queryResults').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-play-circle fa-3x mb-3"></i>
                        <h5>Ready to Execute</h5>
                        <p>Enter a JPQL query above and click "Execute Query" to see results</p>
                    </div>
                `;

                // Hide result badges
                document.getElementById('lastExecutionTime').style.display = 'none';
                document.getElementById('resultCount').style.display = 'none';
            }

            formatQuery() {
                const query = this.currentQuery.trim();
                if (!query) return;

                // Simple JPQL formatting
                const formatted = query
                    .replace(/\bSELECT\b/gi, '\nSELECT')
                    .replace(/\bFROM\b/gi, '\nFROM')
                    .replace(/\bWHERE\b/gi, '\nWHERE')
                    .replace(/\bAND\b/gi, '\n  AND')
                    .replace(/\bOR\b/gi, '\n  OR')
                    .replace(/\bORDER BY\b/gi, '\nORDER BY')
                    .replace(/\bGROUP BY\b/gi, '\nGROUP BY')
                    .replace(/\bHAVING\b/gi, '\nHAVING')
                    .replace(/\bJOIN\b/gi, '\nJOIN')
                    .replace(/\bLEFT JOIN\b/gi, '\nLEFT JOIN')
                    .replace(/\bRIGHT JOIN\b/gi, '\nRIGHT JOIN')
                    .replace(/\bINNER JOIN\b/gi, '\nINNER JOIN')
                    .trim();

                document.getElementById('jpqlQueryInput').value = formatted;
                this.updateQueryInfo();
            }

            saveQueryToLocalStorage() {
                localStorage.setItem('jpql-demo-query', this.currentQuery);
            }

            saveQuery() {
                // This could be extended to save to server
                this.saveQueryToLocalStorage();
                this.showToast('success', 'Query saved locally');
            }

            loadUserPreferences() {
                // Load user preferences from localStorage
                const prefs = localStorage.getItem('jpql-demo-preferences');
                if (prefs) {
                    try {
                        const preferences = JSON.parse(prefs);
                        // Apply preferences
                        console.log('Loaded user preferences:', preferences);
                    } catch (e) {
                        console.error('Failed to load preferences:', e);
                    }
                }
            }

            exportResults(format) {
                // Implementation for exporting results
                this.showToast('info', `Exporting results as ${format.toUpperCase()}...`);
            }

            handleEditorKeydown(event) {
                // Handle special editor behaviors
                if (event.key === 'Tab') {
                    event.preventDefault();
                    const input = event.target;
                    const start = input.selectionStart;
                    const end = input.selectionEnd;

                    // Insert 2 spaces for tab
                    input.value = input.value.substring(0, start) + '  ' + input.value.substring(end);
                    input.selectionStart = input.selectionEnd = start + 2;

                    this.updateQueryInfo();
                }
            }

            showToast(type, message) {
                document.getElementById(type + 'Message').textContent = message;
                const toast = new bootstrap.Toast(document.getElementById(type + 'Toast'));
                toast.show();
            }
        }

        // Initialize the JPQL Demo Manager
        let jpqlDemo;
        document.addEventListener('DOMContentLoaded', function() {
            jpqlDemo = new JPQLDemoManager();
        });

        // Global functions for HTML onclick handlers
        function executeQuery() {
            jpqlDemo.executeQuery();
        }

        function clearEditor() {
            jpqlDemo.clearEditor();
        }

        function formatQuery() {
            jpqlDemo.formatQuery();
        }

        function explainQuery() {
            jpqlDemo.explainQuery();
        }

        function updateQueryInfo() {
            jpqlDemo.updateQueryInfo();
        }

        function handleEditorKeydown(event) {
            jpqlDemo.handleEditorKeydown(event);
        }

        function exportResults(format) {
            jpqlDemo.exportResults(format);
        }
    </script>
</body>
</html>
